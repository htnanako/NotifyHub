## 插件开发指南

本文档介绍如何为 NotifyHub 开发插件，包括 `manifest.json` 规范、插件路由注册规范、插件配置读取、系统配置读取与内置发送消息功能的使用方法。

### 基础目录结构与加载

- **PLUGINS_DIR**: 在映射的`/data`目录下有`plugins`目录，系统会自动扫描该目录下的所有 Python 模块并注入其中的 `APIRouter`(若有)。
- **插件目录结构（建议）**:
  - `/data/plugins/<plugin_id>/manifest.json`
  - `/data/plugins/<plugin_id>/__init__.py`
  - `/data/plugins/<plugin_id>/*.py`
  - `/data/plugins/<plugin_id>/frontend/` (可选，前端文件目录)

### 1. manifest.json 配置规范

顶层字段（均为字符串，除数组字段外）：

- **id**: 插件唯一 ID（建议与目录名相同）
- **name**: 插件名称
- **description**: 插件描述
- **author**: 作者
- **logo**: 插件 Logo 链接
- **version**: 版本号
- **documentation**: 文档链接(若无可设置空字符串)
- **path**: 插件在后端 API 下的路由前缀（建议与 `APIRouter(prefix=...)` 保持一致）
- **configField**: 配置表单字段数组
- **helpTextField**: 说明文本数组
- **frontend_page**: 前端页面配置，包含 `name`、`path`、`icon`、`add_to_menu`

#### 前端页面（frontend_page）说明

用于配置主程序可识别的插件前端页面，支持在“插件页面”菜单中展示入口卡片与菜单项。

- 字段说明：
  - `name`: 页面名称（展示用）
  - `path`: 页面访问路径（示例：`/common/view?hidePadding=true#/api/plugins/{plugin_id}/frontend/index.html`）
  - `icon`: 图标，采用 Iconify 图标库名称（例如：`mdi:archive-arrow-down-outline`）。参考 Iconify 索引见：[Iconify 图标库](https://icon-sets.iconify.design/)
  - `add_to_menu`: 是否添加到主程序菜单（布尔值）。为 `true` 时，主程序会将该页面加入前端菜单“插件页面”分组下

示例：

```json
{
  "id": "plugin_example",
  "name": "插件示例",
  "description": "示例插件",
  "path": "/plugin_example",
  "frontend_page": {
    "name": "前端示例",
    "icon": "mdi:star-four-points-outline",
    "path": "/common/view?hidePadding=true#/api/plugins/plugin_example/frontend/index.html",
    "add_to_menu": true
  }
}
```

配置表单字段 `configField`（数组，元素为对象）：

- **fieldName**: 字段键名（保存/读取用）
- **fieldType**: 字段类型，支持：
  - `string`（字符串类型）
  - `select`（单选下拉框）
  - `multi_select`（多选下拉框）
  - `switch`（开关）
  - `enum`（动态枚举占位类型，后端会自动转换为 `select` 或 `multi_select`，详见下文“枚举类型（enum）说明”）
- **label**: 字段显示名称
- **helpText**: 可选，辅助说明
- **defaultValue**: 可选，默认值（`string | boolean | string[]`）
- **required**: 可选，是否必填（默认必填；注意：`switch` 类型不参与必填校验）
- **options**: 可选，仅 `select`/`multi_select` 用。元素形如：`{ value: string, label: string, group?: string, type?: string, category?: string }`。其中 `group`/`type`/`category` 任一存在即可触发前端分组展示。

#### 条件显示（conditional）说明

- 用途：根据其他字段值联动显示/隐藏当前字段。
- 结构：
  - `field`: 依赖字段名（即另一个配置项的 `fieldName`）
  - `operator`: 支持：`equals` | `not_equals` | `contains` | `greater_than` | `less_than`
  - `value`: 比较值

行为说明：
- 条件不满足时，字段在前端隐藏，且不会参与必填校验。
- `contains` 适用于数组或字符串字段；`greater_than`/`less_than` 适用于数字，或可转换为数字的字符串。

示例 1（开关联动输入框）：

```json
{
  "configField": [
    {
      "fieldName": "cron_task",
      "fieldType": "switch",
      "label": "定时任务",
      "helpText": "是否开启定时任务",
      "defaultValue": false
    },
    {
      "fieldName": "cron_task_time",
      "fieldType": "string",
      "label": "定时任务时间",
      "helpText": "定时任务的时间，格式为五位 cron 表达式",
      "defaultValue": "0 8 * * *",
      "required": false,
      "conditional": {
        "field": "cron_task",
        "operator": "equals",
        "value": true
      }
    }
  ]
}
```

示例 2（多选包含联动）：

```json
{
  "configField": [
    {
      "fieldName": "bind_routes",
      "fieldType": "multi_select",
      "label": "绑定通道",
      "options": [
        { "value": "router_a", "label": "通道A" },
        { "value": "router_b", "label": "通道B" }
      ],
      "defaultValue": []
    },
    {
      "fieldName": "route_detail",
      "fieldType": "string",
      "label": "通道A额外配置",
      "required": false,
      "conditional": {
        "field": "bind_routes",
        "operator": "contains",
        "value": "router_a"
      }
    }
  ]
}
```

#### 枚举类型（enum）说明

当需要引用系统内的“动态选项”（如渠道列表、通道列表）时，推荐使用 `fieldType: "enum"`。该类型为后端占位类型，后端会根据 `enumValuesRef` 自动填充 `options`，并根据 `multiValue` 转换为 `select` 或 `multi_select`。

- 必填字段/行为：
  - **fieldType**: 固定为 `enum`
  - **enumValuesRef**: 选项来源标识，当前支持：
    - `ChannelList`: 渠道列表（选项 value 为“渠道名称”，label 为“渠道名称”）
    - `RouterList`: 通道列表（选项 value 为“通道 ID”，label 为“通道名称”）
  - **multiValue**: 是否多选，布尔值；
    - `true` 则自动转为 `multi_select`
    - `false` 或不填则自动转为 `select`
- 非必填字段：
  - `options`: 使用 `enum` 时无需在 manifest 中提供，后端会自动注入。

示例：

```json
{
  "configField": [
    {
      "fieldName": "bind_channel",
      "fieldType": "enum",
      "label": "绑定渠道（单选）",
      "enumValuesRef": "ChannelList",
      "multiValue": false
    },
    {
      "fieldName": "bind_routes",
      "fieldType": "enum",
      "label": "绑定通道（多选）",
      "enumValuesRef": "RouterList",
      "multiValue": true
    }
  ]
}
```

说明：
- 清单加载时，后端会将上述两个字段分别转换为 `select` 与 `multi_select`，并自动注入 `options`。

说明文本 `helpTextField`（数组，元素为对象）：

- **fieldType**: 支持：`title` | `text` | `code`
- **value**: 文本内容或代码内容。`code` 类型中支持占位符 `{site_url}`，前端会自动替换为系统配置的站点地址（或浏览器 `window.location.origin`）。

示例（节选自测试插件）：

```json
{
  "id": "plugin_test",
  "name": "插件测试",
  "description": "插件测试",
  "author": "NotifyHub",
  "logo": "https://example.com/logo.png",
  "version": "0.0.1",
  "documentation": "https://www.baidu.com",
  "path": "/plugin_test",
  "configField": [
    {
        "fieldName": "test_url",
        "fieldType": "string",
        "label": "测试URL",
        "helpText": "测试URL地址",
        "defaultValue": "https://www.baidu.com"
    },
    {
        "fieldName": "test_select",
        "fieldType": "select",
        "label": "测试单选配置项",
        "options": [
            {"value":"option1","label":"选项1"},
            {"value":"option2","label":"选项2"}
        ],
        "defaultValue": "option1"
    },
    {
        "fieldName": "test_multi_select",
        "fieldType": "multi_select",
        "label": "测试多选配置项",
        "options": [
            {"value":"option1","label":"选项1","type":"type1"},
            {"value":"option2","label":"选项2","type":"type1"},
            {"value":"option3","label":"选项3","type":"type2"}
        ],
        "defaultValue": ["option1", "option2"]
    },
    {
        "fieldName": "test_switch",
        "fieldType": "switch",
        "label": "测试开关配置项",
        "defaultValue": true
    }
  ],
  "helpTextField": [
    { "fieldType": "title", "value": "这是一个测试插件，这是说明文本的标题" },
    { "fieldType": "text", "value": "这是一个测试插件，这是说明文本的内容" },
    { "fieldType": "code", "value": "{site_url}/api/plugins/plugin_test/demo" }
  ]
}
```

### 2. 插件额外依赖配置

插件可以包含额外的依赖，用于在插件初始化时安装。

- 依赖文件：`requirements.txt`
- 依赖安装：系统会自动扫描插件目录下的 `requirements.txt` 文件，并安装其中的依赖。


示例：

```txt
requests
```

或带版本号控制：

```txt
requests>=2.28.1
```


### 3. 插件 APIRouter 注册要求

- 在插件任意 `.py` 模块(除__init__.py)内定义 FastAPI 的 `APIRouter` 实例，**变量名必须以 `router` 结尾**，例如：`my_plugin_router`、`event_router`。
- 建议为该 `APIRouter` 设置 `prefix` 为插件路由前缀，与 `manifest.json` 的 `path` 保持一致，便于自描述与排查。
- 系统会自动将第三方插件路由挂载到后端统一前缀下：`/api/plugins`。
  - 若 `APIRouter(prefix="/my_plugin")`，则最终路径形如：`/api/plugins/my_plugin/...`
- 是否注册成功，可放置文件到插件目录下后重启程序查看日志，是否有形如 `插件 my_plugin 注入路由 my_plugin_router: /api/plugins/my_plugin/ping` 的日志。

示例：

```python
from fastapi import APIRouter

my_plugin_router = APIRouter(prefix="/plugin_test", tags=["plugin_test"])

@my_plugin_router.get("/ping")
async def ping():
    return {"ok": True}
```

### 4. 插件配置获取（后端）

使用 `notifyhub.plugins.utils` 提供的便捷方法。

```python
from notifyhub.plugins.utils import (
    get_plugin_data,
    get_plugin_config
)

plugin_id = "plugin_test"

# 获取原始存储数据（含名称等元信息）
data = get_plugin_data(plugin_id)  # 存在时返回字典，不存在返回 None

# 获取配置字典
config = get_plugin_config(plugin_id)  # 返回 dict，不存在时返回空字典 {}
```


### 5. 获取系统内其他配置（后端）

通过 `notifyhub.controller.server` 中的全局实例 `server` 获取渠道/通道的配置或名称列表。

```python
from notifyhub.controller.server import server

# 渠道配置列表（List[Dict]）
channels = server.notify_channels_config

# 渠道名称列表（List[str]）
channel_names = server.notify_channels_name

# 通道配置列表（List[Dict]）
routes = server.notify_routers_config

# 通道名称列表（List[str]）
route_names = server.notify_routers_name
```

### 6. 内置发送消息功能（后端）

同样使用 `server` 实例，支持直接向指定“渠道”或“通道”发送通知。

```python
from notifyhub.controller.server import server

# 按渠道发送（单个渠道）
server.send_notify_by_channel(
    channel_name="telegram",
    title="标题",
    content="内容",
    push_img_url="https://example.com/img.png",      # 可选
    push_link_url="https://example.com/detail"       # 可选
)

# 按通道发送（通道会绑定一个或多个渠道）
server.send_notify_by_router(
    route_id="my_route_id",
    title="标题",
    content="内容",
    push_img_url=None, # 可选
    push_link_url=None # 可选
)
```

### 7. 初始化钩子 after_setup（后端）

提供 `after_setup` 装饰器，用于在应用完成基础初始化后执行插件的初始化逻辑（如：准备资源、注册定时任务等）。支持同步/异步函数。

使用位置：插件任意模块（除 `__init__.py`）内。

```python
from notifyhub.plugins.common import after_setup

# 同步初始化逻辑
@after_setup(plugin_id="my_plugin", desc="初始化资源或注册任务")
def init_resources():
    # 执行同步初始化逻辑
    pass

# 异步初始化逻辑
@after_setup(plugin_id="my_plugin", desc="异步初始化逻辑")
async def init_async_resources():
    # 执行异步初始化逻辑
    pass
```

说明：
- `plugin_id` 建议与插件目录名/manifest `id` 保持一致，便于日志排查。
- 系统会在应用启动流程中统一执行所有通过 `after_setup` 注册的函数。

### 8. 定时任务调度器（后端）

内置基于 APScheduler 的调度能力，插件可以在导入或初始化阶段注册五段 cron 表达式的定时任务。调度器由系统统一在应用启动后启动、关闭时优雅停止。

重要：请在 `after_setup` 装饰的函数中调用 `register_cron_job` 完成定时任务注册，确保应用初始化完成后再注册任务。

- 五段 cron 表达式格式：`minute hour day month day_of_week`
  - 例：`*/5 * * * *` 每 5 分钟执行一次；`0 3 * * *` 每天 03:00 执行

- 同步/异步示例：

```python
from notifyhub.plugins.common import after_setup
from notifyhub.controller.schedule import register_cron_job

# 定义任务函数
def sync_task():
    logger.info("同步任务执行")

async def async_task():
    logger.info("异步任务执行")

# 在 after_setup 中注册定时任务（同步示例）
@after_setup(plugin_id="my_plugin", desc="注册定时任务")
def setup_cron_jobs():
    register_cron_job("*/5 * * * *", "示例同步任务", sync_task, random_delay_seconds=10)

# 在 after_setup 中注册定时任务（异步示例）
@after_setup(plugin_id="my_plugin", desc="注册异步定时任务")
async def setup_async_cron_jobs():
    register_cron_job("0 3 * * *", "每日异步任务", async_task)
```

说明：
- `random_delay_seconds`>0 时，每次触发会在 0~N 秒内随机延迟后再执行，避免同一时间大量任务并发。
- 注册阶段无需手动启动调度器；系统会在应用生命周期中统一启动。

### 建议与注意事项

- **命名一致性**：`manifest.json` 的 `id`、目录名和 `APIRouter(prefix=...)` 建议保持一致。
- **路由前缀**：请确保 `manifest.json.path` 与 `APIRouter(prefix=...)` 对齐，以便前后端引用一致、查找方便。
- **下拉分组**：在 `options` 中可使用 `group` / `type` / `category` 任一键进行分组；前端会自动识别并分组展示。
- **帮助占位符**：`helpTextField` 中 `code` 类型支持 `{site_url}` 占位符替换。
- **必填校验**：前端对 `switch` 类型不做必填校验；其他类型若未显式 `required:false`，默认视为必填。

### 9. 插件前端页面访问

插件可以包含前端页面，通过以下方式访问：

- **前端文件放置**：将前端文件（HTML、CSS、JS等）放置在插件目录下的 `frontend` 文件夹中
- **访问路径**：通过 `/common/view?hidePadding=true#/api/plugins/{plugin_id}/frontend/index.html` 路由访问插件前端页面，`{plugin_id}` 为插件 ID，与插件文件夹名称一致
- **示例目录结构**：
  ```
  /data/plugins/my_plugin/
  ├── manifest.json
  ├── __init__.py
  ├── my_plugin.py
  └── frontend/
      ├── index.html
      ├── style.css
      └── script.js
  ```

### 10. 插件主动重启程序（后端）

使用 `notifyhub.controller.server` 中的全局实例 `server` 重启程序。

```python
from notifyhub.controller.server import server

server.restart_app()
```
